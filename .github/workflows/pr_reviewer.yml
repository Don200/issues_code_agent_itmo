name: PR Reviewer - AI Review Agent

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  workflow_run:
    workflows: ["CI"]  # Run after CI completes
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: read

env:
  PYTHON_VERSION: "3.11"

jobs:
  review:
    runs-on: ubuntu-latest
    # Skip draft PRs and only run for PRs created by the agent or with 'review' label
    if: |
      !github.event.pull_request.draft &&
      (
        contains(github.event.pull_request.labels.*.name, 'auto-review') ||
        contains(github.event.pull_request.title, '[SDLC Agent]') ||
        github.event.pull_request.user.login == 'github-actions[bot]'
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Extract Issue Number
        id: extract_issue
        run: |
          # Try to extract issue number from PR body (Closes #XX or Fixes #XX)
          ISSUE_NUM=$(echo "${{ github.event.pull_request.body }}" | grep -oP '(?:Closes|Fixes|Resolves)\s*#\K\d+' | head -1 || echo "")
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT

      - name: Wait for CI to complete
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;

            // Wait up to 10 minutes for CI
            const maxWait = 10 * 60 * 1000;
            const checkInterval = 30 * 1000;
            let waited = 0;

            while (waited < maxWait) {
              const { data: checks } = await github.rest.checks.listForRef({
                owner,
                repo,
                ref: pr.head.sha,
              });

              const pendingChecks = checks.check_runs.filter(
                c => c.status !== 'completed' && c.name !== 'review'
              );

              if (pendingChecks.length === 0) {
                console.log('All CI checks completed');
                break;
              }

              console.log(`Waiting for ${pendingChecks.length} checks to complete...`);
              await new Promise(resolve => setTimeout(resolve, checkInterval));
              waited += checkInterval;
            }

      - name: Run AI Review
        id: review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          ISSUE_ARG=""
          if [ -n "${{ steps.extract_issue.outputs.issue_number }}" ]; then
            ISSUE_ARG="--issue ${{ steps.extract_issue.outputs.issue_number }}"
          fi

          python -m src.cli review ${{ github.event.pull_request.number }} $ISSUE_ARG --log-level INFO --log-format json

      - name: Check and Decide Next Action
        id: decide
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          ISSUE_ARG=""
          if [ -n "${{ steps.extract_issue.outputs.issue_number }}" ]; then
            ISSUE_ARG="--issue ${{ steps.extract_issue.outputs.issue_number }}"
          fi

          python -m src.cli check ${{ github.event.pull_request.number }} $ISSUE_ARG --log-level INFO


  # Job to handle fix iterations
  fix-iteration:
    runs-on: ubuntu-latest
    needs: review
    if: failure() && contains(github.event.pull_request.labels.*.name, 'auto-fix')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Configure Git
        run: |
          git config --global user.name "SDLC Agent"
          git config --global user.email "sdlc-agent@github.actions"

      - name: Get iteration count
        id: iteration
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;

            // Count commits as proxy for iterations
            const { data: commits } = await github.rest.pulls.listCommits({
              owner,
              repo,
              pull_number: pr.number,
            });

            // Filter agent commits
            const agentCommits = commits.filter(c =>
              c.commit.author.name === 'SDLC Agent'
            );

            const iteration = agentCommits.length + 1;
            console.log(`Current iteration: ${iteration}`);
            return iteration;
          result-encoding: string

      - name: Check max iterations
        if: steps.iteration.outputs.result > vars.MAX_ITERATIONS || 5
        run: |
          echo "Max iterations reached. Stopping auto-fix."
          exit 0

      - name: Extract Issue Number
        id: extract_issue
        run: |
          ISSUE_NUM=$(echo "${{ github.event.pull_request.body }}" | grep -oP '(?:Closes|Fixes|Resolves)\s*#\K\d+' | head -1 || echo "")
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT

      - name: Run Fix Cycle
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "${{ steps.extract_issue.outputs.issue_number }}" ]; then
            echo "No linked issue found. Cannot run fix cycle."
            exit 1
          fi

          python -m src.cli run-cycle \
            ${{ steps.extract_issue.outputs.issue_number }} \
            --max-iterations 1 \
            --log-level INFO
