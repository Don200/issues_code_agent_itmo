version: '3.8'

services:
  # Web interface - start with: docker-compose up web
  web:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Langfuse
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_BASE_URL=${LANGFUSE_BASE_URL:-}
    volumes:
      - ./workspace:/app/workspace
      - ./logs:/app/logs
    working_dir: /app
    # Default CMD is web server

  # CLI agent - run commands with: docker-compose run --rm agent <command>
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAX_ITERATIONS=${MAX_ITERATIONS:-5}
      # Langfuse
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_BASE_URL=${LANGFUSE_BASE_URL:-}
    volumes:
      - ./workspace:/app/workspace
      - ./logs:/app/logs
    working_dir: /app
    command: ["--help"]  # Override default web CMD

  # Test runner
  test:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - PYTHONPATH=/app
    volumes:
      - .:/app
    working_dir: /app
    entrypoint: ["pytest"]
    command: ["tests/", "-v", "--cov=src", "--cov-report=term-missing"]

  # Linting
  lint:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
    working_dir: /app
    entrypoint: ["/bin/bash", "-c"]
    command: ["ruff check src/ tests/ && black --check src/ tests/ && mypy src/"]
