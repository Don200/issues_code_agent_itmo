version: '3.8'

services:
  sdlc-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sdlc-agent
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - YANDEX_API_KEY=${YANDEX_API_KEY:-}
      - YANDEX_FOLDER_ID=${YANDEX_FOLDER_ID:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAX_ITERATIONS=${MAX_ITERATIONS:-5}
    volumes:
      - ./workspace:/app/workspace
      - ./logs:/app/logs
    working_dir: /app
    stdin_open: true
    tty: true

  # Development service with hot reload
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sdlc-agent-dev
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - YANDEX_API_KEY=${YANDEX_API_KEY:-}
      - YANDEX_FOLDER_ID=${YANDEX_FOLDER_ID:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - MAX_ITERATIONS=${MAX_ITERATIONS:-5}
    volumes:
      - .:/app
      - ./workspace:/app/workspace
      - ./logs:/app/logs
    working_dir: /app
    command: ["--help"]
    stdin_open: true
    tty: true

  # Test runner
  test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sdlc-agent-test
    environment:
      - PYTHONPATH=/app
    volumes:
      - .:/app
    working_dir: /app
    entrypoint: ["pytest"]
    command: ["tests/", "-v", "--cov=src", "--cov-report=term-missing"]

  # Linting service
  lint:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sdlc-agent-lint
    volumes:
      - .:/app
    working_dir: /app
    entrypoint: ["/bin/bash", "-c"]
    command: ["ruff check src/ tests/ && black --check src/ tests/ && mypy src/"]
